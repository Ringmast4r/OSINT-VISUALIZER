<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Spire Visualizer — OSINT (Mock Demo)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f7f7fb;--fg:#0f172a;--muted:#64748b;--card:#fff;--border:#e2e8f0;--accent:#111827
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .header{position:sticky;top:0;background:rgba(255,255,255,.8);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);padding:12px 16px;margin:-24px 0 16px}
  .brand{display:flex;align-items:center;gap:12px;max-width:1200px;margin:0 auto}
  .logo{width:40px;height:40px;border-radius:12px;background:#0f172a;color:#fff;display:flex;align-items:center;justify-content:center}
  h1{margin:0;font-size:20px} .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .row{display:flex;gap:8px;margin:14px 0}
  input[type="text"]{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
  button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .gridMain{display:grid;grid-template-columns:1fr 2fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer;box-shadow:0 0 0 2px transparent inset;transition:box-shadow .15s}
  .chip.active{color:#fff;border-color:#111}
  .chip .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .chipRow{display:flex;gap:10px;margin-top:8px}
  .muted{color:var(--muted)}
  .listMetrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px}
  .metric{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
  .metric .k{font-weight:700;font-size:20px}
  .canvasWrap{height:380px;border:1px solid var(--border);border-radius:16px;display:flex;align-items:center;justify-content:center;background:#fff}
  canvas{width:100%;height:100%}
  .resultsHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .groups{display:flex;flex-direction:column;gap:14px}
  .groupTitle{display:flex;align-items:center;gap:8px;font-weight:600}
  .legendDot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
  .item a{color:inherit;text-decoration:none}
  .item .title{font-weight:600;margin-bottom:6px}
  .item .subtle{font-size:12px;color:var(--muted)}
  .toolbar{display:flex;gap:10px;margin-top:8px}
  .toolbar a{font-size:13px}
</style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">DB</div>
      <div>
        <h1>Spire Visualizer</h1>
        <div class="sub">OSINT API Search · radial source aggregation (mock demo)</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="row">
      <input id="q" placeholder="Search (name, company, address, keyword…)" />
      <button id="btn">Search</button>
    </div>

    <div class="gridMain">
      <!-- Filters / counts -->
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 4h18l-7 8v6l-4 2v-8L3 4z" stroke="#0f172a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <strong>Sources</strong>
        </div>
        <div id="chips" class="chips"></div>
        <div class="toolbar">
          <a href="#" id="selectAll">Select all</a>
          <a href="#" id="clearAll">Clear</a>
        </div>
        <div class="muted" style="margin-top:10px">
          Total hits: <strong id="hits">0</strong><br/>
          Active sources: <strong id="activeCount">0</strong>
        </div>
      </div>

      <!-- Spires -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Source Spires</strong>
          <div class="muted">Height = hits · Arc = avg confidence · Color per source</div>
        </div>
        <div class="canvasWrap">
          <canvas id="spireCanvas"></canvas>
        </div>

        <!-- Metrics strip -->
        <div id="metrics" class="listMetrics"></div>
      </div>
    </div>

    <!-- Results -->
    <div class="card" style="margin-top:16px">
      <div class="resultsHead">
        <strong>Results</strong>
        <div class="muted">Grouped by source · newest first</div>
      </div>
      <div id="groups" class="groups"></div>
    </div>
  </div>

<script>
/* ===== Palette & Sources (match the earlier look) ===== */
const PALETTE = {
  FEC:"#2563eb",          // blue
  GovInfo:"#16a34a",      // green
  OpenCorporates:"#f59e0b", // amber
  EPA:"#dc2626",          // red
  "SAM.gov":"#7c3aed",    // violet
  FCC:"#0ea5e9",          // sky
  CollegeScorecard:"#059669", // emerald
  unknown:"#9ca3af"
};
const SOURCES = ["FEC","GovInfo","OpenCorporates","EPA","SAM.gov","FCC","CollegeScorecard"];

let active = new Set(SOURCES);
let data = []; // flat list of items

/* ===== DOM ===== */
const chipsEl = document.getElementById("chips");
const hitsEl  = document.getElementById("hits");
const activeCountEl = document.getElementById("activeCount");
const metricsEl = document.getElementById("metrics");
const groupsEl  = document.getElementById("groups");
const qEl       = document.getElementById("q");
const btnEl     = document.getElementById("btn");
const canvas    = document.getElementById("spireCanvas");
const ctx       = canvas.getContext("2d");

/* ===== UI: chips ===== */
SOURCES.forEach((s)=>{
  const b = document.createElement("button");
  b.className = "chip active";
  b.style.boxShadow = `0 0 0 2px ${PALETTE[s]} inset`;
  b.style.background = "#fff";
  b.dataset.source = s;
  b.innerHTML = `<span class="dot" style="background:${PALETTE[s]}"></span>${s}`;
  b.onclick = () => { toggleSource(s,b); };
  chipsEl.appendChild(b);
});
document.getElementById("selectAll").onclick = (e)=>{e.preventDefault(); active = new Set(SOURCES); refreshChipStates(); render();};
document.getElementById("clearAll").onclick  = (e)=>{e.preventDefault(); active = new Set(); refreshChipStates(); render();};
function toggleSource(s,btn){
  if (active.has(s)) { active.delete(s); btn.classList.remove("active"); btn.style.color = ""; btn.style.background="#fff"; }
  else { active.add(s); btn.classList.add("active"); btn.style.color="#fff"; btn.style.background=PALETTE[s]; }
  render();
}
function refreshChipStates(){
  chipsEl.querySelectorAll(".chip").forEach(btn=>{
    const s = btn.dataset.source;
    if (active.has(s)) { btn.classList.add("active"); btn.style.color="#fff"; btn.style.background=PALETTE[s]; }
    else { btn.classList.remove("active"); btn.style.color=""; btn.style.background="#fff"; }
  });
}

/* ===== Mock data ===== */
function mockItems(q, source, nMin=3, nMax=9){
  const n = nMin + Math.floor(Math.random()*(nMax-nMin+1));
  const now = Date.now();
  const out = [];
  for (let i=0;i<n;i++){
    out.push({
      id:`${source}-${i}-${Math.random().toString(36).slice(2,7)}`,
      title:`${source} match ${i+1} · ${q || 'sample'}`,
      url:"https://example.com/item",
      summary:`Synthetic preview text for “${q || 'query'}” from ${source}.`,
      source,
      confidence:0.55 + Math.random()*0.4,  // 0.55..0.95
      severity:Math.floor(Math.random()*100),
      timestamp:new Date(now - Math.random()*86_400_000*14).toISOString()
    });
  }
  return out;
}

/* ===== Aggregate & render ===== */
function aggregateBySource(items){
  const m = new Map();
  for (const it of items){
    const k = it.source || "unknown";
    if (!m.has(k)) m.set(k,{source:k,hits:0,confSum:0});
    const r = m.get(k);
    r.hits += 1;
    r.confSum += (it.confidence || 0);
  }
  const arr = Array.from(m.values()).map(r=>({
    source:r.source,
    hits:r.hits,
    avgConfidence:r.confSum / Math.max(1,r.hits),
    color:PALETTE[r.source] || PALETTE.unknown
  }));
  arr.sort((a,b)=>b.hits - a.hits);
  return arr;
}
function fmtPct(x){ return `${Math.round((x||0)*100)}%`; }
function fmtInt(x){ return new Intl.NumberFormat().format(x||0); }
function fmtDate(iso){ const d=new Date(iso); return isNaN(+d)?"":d.toLocaleString(); }

/* ===== Spires (canvas custom) ===== */
function drawSpires(aggs){
  // size canvas for device pixel ratio
  const dpr = window.devicePixelRatio || 1;
  const {clientWidth:w, clientHeight:h} = canvas;
  canvas.width  = w * dpr;
  canvas.height = h * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,w,h);

  const cx = w/2, cy = h/2 + 20; // center a bit lower
  const ringGap = 22;            // distance between rings
  const baseR   = 28;            // inner radius

  // Background faint rings for context
  ctx.strokeStyle = "#e5e7eb";
  for (let r=baseR; r< Math.min(w,h)/2 - 8; r+=ringGap){
    ctx.beginPath();
    ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  // For each source, draw an arc: lineWidth ~ hits; arc length ~ avg confidence
  aggs.forEach((a, idx)=>{
    const r = baseR + idx*ringGap;
    const lw = Math.min(6 + a.hits, 32); // “height”
    const angle = (a.avgConfidence || 0) * Math.PI*2; // “arc”
    const start = -Math.PI/2;
    ctx.beginPath();
    ctx.arc(cx,cy,r,start,start + Math.max(angle, Math.PI*0.08)); // ensure a tiny visible arc
    ctx.strokeStyle = a.color;
    ctx.lineCap = "round";
    ctx.lineWidth = lw;
    ctx.stroke();
  });
}

/* ===== UI render ===== */
function render(){
  const filtered = data.filter(d=>active.has(d.source));
  const aggs = aggregateBySource(filtered);
  hitsEl.textContent = fmtInt(filtered.length);
  activeCountEl.textContent = active.size;

  // Metrics strip
  metricsEl.innerHTML = aggs.map(a=>`
    <div class="metric">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="muted">${a.source}</span>
        <span class="legendDot" style="background:${a.color}"></span>
      </div>
      <div class="k">${fmtInt(a.hits)}</div>
      <div class="muted">avg conf ${fmtPct(a.avgConfidence)}</div>
    </div>
  `).join("");

  // Spires
  drawSpires(aggs);

  // Results grouped
  const groups = groupBySource(filtered);
  groupsEl.innerHTML = groups.map(([src,arr],i)=>{
    const color = PALETTE[src] || PALETTE.unknown;
    const cards = arr.map(it=>`
      <div class="item">
        <a href="${it.url}" target="_blank" rel="noreferrer">
          <div class="title">${escapeHtml(it.title)}</div>
          <div class="subtle" style="margin:6px 0">${escapeHtml(it.summary)}</div>
          <div class="subtle">${src} · conf ${fmtPct(it.confidence)} · ${fmtDate(it.timestamp)}</div>
        </a>
      </div>
    `).join("");
    return `
      <div>
        <div class="groupTitle">
          <span class="legendDot" style="background:${color}"></span>
          ${src} <span class="muted">(${arr.length})</span>
        </div>
        <div class="cards">${cards}</div>
      </div>
    `;
  }).join("") || `<div class="muted">No results yet. Toggle sources or run a search.</div>`;
}
function groupBySource(items){
  const m = new Map();
  for (const it of items){
    const k = it.source || "unknown";
    if (!m.has(k)) m.set(k,[]);
    m.get(k).push(it);
  }
  for (const [k,arr] of m.entries()){
    arr.sort((a,b)=> (new Date(b.timestamp||0)) - (new Date(a.timestamp||0)));
    m.set(k,arr);
  }
  return Array.from(m.entries());
}
function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))}

/* ===== Interactions ===== */
btnEl.onclick = runSearch;
qEl.addEventListener("keydown",(e)=> e.key==="Enter" && runSearch());
function runSearch(){
  const q = qEl.value.trim() || "demo";
  // fresh mock per active source
  let out = [];
  active.forEach(s => { out = out.concat(mockItems(q,s)); });
  data = out;
  render();
}

/* ===== Kickoff ===== */
qEl.value = ""; // start with an empty input
// don’t auto-run search, wait for user input
render();

